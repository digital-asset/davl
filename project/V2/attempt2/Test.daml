daml 1.2

module Test where

import Davl
import DA.Date

basic_flow = scenario do

  company <- getParty "the-company"
  dilbert <- getParty "dilbert"
  pointy <- getParty "pointy-haired-boss"

  ac <- submit company $ create AsCompany with company
  ad <- submit dilbert $ create AsWorker with worker = dilbert
  ap <- submit pointy $ create AsWorker with worker = pointy
  apb <- submit pointy $ create AsBoss with boss = pointy

  p1 <- submit company $ exercise ac AsCompany_ProposeWorker with worker = dilbert
  submit dilbert $ exercise ad AsWorker_AcceptProposeWorker with proposal = p1

  [h1,h2,h3] <- submit company $ exercise ac AsCompany_AllocateHoliday with worker = dilbert; nDays = 3

  let xmas : Date = date 2019 Dec 25
  let boxing : Date = date 2019 Dec 26
  r1 <- submit dilbert $ exercise ad AsWorker_RequestVacation with dates = [xmas,boxing]

  xs <- submit dilbert $ exercise ad AsWorker_GetPending
  assertMsg "dilbert, penning=1" (length xs==1)

  let newYearEve : Date = date 2019 Dec 31
  let newYearDay : Date = date 2020 Jan 01
  r2 <- submit dilbert $ exercise ad AsWorker_RequestVacation with dates = [newYearEve,newYearDay]

  xs <- submit dilbert $ exercise ad AsWorker_GetPending
  assertMsg "dilbert, pending=2" (length xs==2)

  p2 <- submit company $ exercise ac AsCompany_ProposeWorker with worker = pointy
  submit pointy $ exercise ap AsWorker_AcceptProposeWorker with proposal = p2

  xs <- submit pointy $ exercise apb AsBoss_GetMinionRequests
  assertMsg "dilbert, minion pending=0" (length xs==0)

  submit company $ exercise ac AsCompany_AddTeam with boss = pointy; minion = dilbert

  -- TODO: next line fails, and I dont understand why
  --xs <- submit pointy $ exercise apb AsBoss_GetMinionRequests
  --assertMsg "dilbert, minion pending=2" (length xs==2)

  return ()
